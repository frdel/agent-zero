<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Agent Zero</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="toast.css">
    <link rel="stylesheet" href="settings.css">
    
    <script>
        window.safeCall = function (name, ...args) {
            if (window[name]) window[name](...args)
        }
    </script>

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" crossorigin="anonymous">

    <!-- KaTeX javascript -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>

    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script type="module" src="index.js"></script>
    <script type="text/javascript" src="settings.js"></script>

</head>

<body>
    <div class="container">
        <div class="icons-section" id="hide-button" x-data="{ connected: true }">
            <!--Sidebar-->
            <!-- Sidebar Toggle Button -->
            <button id="toggle-sidebar" class="toggle-sidebar-button" aria-label="Toggle Sidebar" aria-expanded="false">
                <span aria-hidden="true">
                    <!-- Hamburger Icon -->
                    <svg id="sidebar-hamburger-svg" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="CurrentColor">
                    <path d="M3 13h18v-2H3v2zm0 4h18v-2H3v2zm0-8h18V7H3v2z"></path>
                    </svg>
                </span>
            </button>
            
        <div id="logo-container">
                <a href="https://github.com/frdel/agent-zero" target="_blank" rel="noopener noreferrer">
                    <img src="splash.jpg" alt="a0" width="22" height="22">
                </a>
        </div>
    </div>
        
    <div id="left-panel" class="panel">
        <!--Sidebar upper elements-->
        <div class="left-panel-top">                
            <div class="config-section" id="status-section" x-data="{ connected: true }">
                    <h3>Status</h3>
                    <h4 class="connected" x-show="connected">&#10004; Connected</h4>
                    <h4 class="disconnected" x-show="!connected">&#10008; Disconnected</h4>
                </div>

                <div class="config-section" x-data="{ showQuickActions: true }">
                    <h3>Quick Actions</h3>
                    <button class="config-button" id="resetChat" @click="resetChat()">Reset Chat</button>
                    <button class="config-button" id="newChat" @click="newChat()">New Chat</button>
                    <button class="config-button" id="loadChats" @click="loadChats()">Load Chat</button>
                    <button class="config-button" id="loadChat" @click="saveChat()">Save Chat</button>
                    <button class="config-button" id="settings"
                        @click="settingsModalProxy.openModal()">Settings</button>
                </div>
                <!-- Chats List -->
                <div class="config-section" id="chats-section" x-data="{ contexts: [], selected: '' }"
                x-show="contexts.length > 0">
                <h3>Chats</h3>
                <div class="chats-list-container">
                    <ul class="config-list">
                        <template x-for="context in contexts">
                            <li>
                            <span :class="{'chat-list-button': true, 'font-bold': context.id === selected}"
                                @click="selected = context.id; selectChat(context.id)">
                                Chat #<span x-text="context.no"></span>
                            </span>
                            <button class="edit-button" @click="killChat(context.id)">X</button>
                            </li>
                        </template>
                    </ul>
                </div>
            </div>
        </div>
        <!--Sidebar lower elements-->
        <div class="left-panel-bottom">
            <!-- Preferences -->
            <div class="pref-section" x-data="{ prefOpen: true }">
                <span><h3 class="pref-header" @click="prefOpen = !prefOpen">
                    Preferences
                    <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" 
                        fill="none" stroke="currentColor" stroke-width="2" width="16" height="16" 
                        :class="{'rotated': !prefOpen}">
                        <path d="M8 4l8 8-8 8"/>
                    </svg>
                </h3>
                <ul class="config-list" x-show="prefOpen" x-collapse x-transition>
                    <!-- Preferences Items -->
                    <li x-data="{ autoScroll: true }">
                        <span>Autoscroll</span>
                        <label class="switch">
                            <input id="auto-scroll-switch" type="checkbox" x-model="autoScroll"
                                x-effect="window.safeCall('toggleAutoScroll',autoScroll)">
                            <span class="slider"></span>
                        </label>
                    </li>
                    <li x-data="{ darkMode: localStorage.getItem('darkMode') != 'false' }"
                        x-init="$watch('darkMode', val => toggleDarkMode(val))">
                        <span class="switch-label">Dark mode</span>
                        <label class="switch">
                            <input type="checkbox" x-model="darkMode">
                            <span class="slider"></span>
                        </label>
                    </li>
                    <li x-data="{ showThoughts: true }">
                        <span>Show thoughts</span>
                        <label class="switch">
                            <input type="checkbox" x-model="showThoughts"
                                x-effect="window.safeCall('toggleThoughts',showThoughts)">
                            <span class="slider"></span>
                        </label>
                    </li>
                    <li x-data="{ showJson: false }">
                        <span>Show JSON</span>
                        <label class="switch">
                            <input type="checkbox" x-model="showJson" x-effect="window.safeCall('toggleJson',showJson)">
                            <span class="slider"></span>
                        </label>
                    </li>
                    <li x-data="{ showUtils: false }">
                        <span>Show utility messages</span>
                        <label class="switch">
                            <input type="checkbox" x-model="showUtils"
                                x-effect="window.safeCall('toggleUtils',showUtils)">
                            <span class="slider"></span>
                        </label>
                    </li>
                    </ul>
                </span>
            </div>
            <!-- Version Info -->
            <div class="version-info">
                <span id="a0version">Agent Zero 0.7.1<br>built on 2024-10-16</span>
            </div>
        </div>
    </div>
        <div id="right-panel" class="panel">
            <!--Chat-->
            <div id="time-date"></div>
            <div id="chat-history">
            </div>
            <div id="toast" class="toast">
                <div class="toast__message"></div>
                <button class="toast__copy">Copy</button>
                <button class="toast__close">Close</button>
            </div>
            <div id="progress-bar-box">
            <h4 id="progress-bar-h"><span id="progress-bar-i">|></span><span id="progress-bar"></span></h4>
            </div>
            <div id="input-section" x-data="{ 
                paused: false,
                attachments: [],
                hasAttachments: false,
                
                handleFileUpload(event) {
                    const files = event.target.files;
                    if (files.length + this.attachments.length > 4) {
                        alert('Maximum 4 attachments allowed');
                        return;
                    }
                    
                    Array.from(files).forEach(file => {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = e => {
                                this.attachments.push({
                                    file: file,
                                    url: e.target.result
                                });
                                this.hasAttachments = true;
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
            }">

                <!-- Image preview section -->
                <div x-show="hasAttachments" class="image-preview-section">
                    <template x-for="(image, index) in attachments" :key="index">
                        <div class="preview-item">
                            <img :src="image.url" alt="Preview">
                            <button @click="attachments.splice(index, 1); hasAttachments = attachments.length > 0" 
                                    class="remove-image">&times;</button>
                        </div>
                    </template>
                </div>

                <!-- Top row with input and buttons -->
                <div class="input-row">
                    <!-- Attachment icon with tooltip -->
                    <div class="attachment-wrapper" x-data="{ showTooltip: false }">
                        <label for="file-input" class="attachment-icon" 
                               @mouseover="showTooltip = true" 
                               @mouseleave="showTooltip = false">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/>
                            </svg>
                        </label>
                        <input type="file" id="file-input" 
                               accept=".jpg,.png,.tiff,.bmp" 
                               multiple 
                               style="display: none"
                               @change="handleFileUpload($event)">

                        <div x-show="showTooltip" class="tooltip">
                            Limit: 4 attachments per message
                        </div>
                    </div>
            
                    <!-- Text input -->
                    <textarea id="chat-input" placeholder="Type your message here..." rows="1"></textarea>
            
                    <!-- Send button -->
                    <button class="chat-button" id="send-button" aria-label="Send message">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                            <path d="M25 20 L75 50 L25 80" fill="none" stroke="currentColor" stroke-width="15"></path>
                        </svg>
                    </button>
            
                    <!-- Microphone button -->
                    <button class="chat-button" id="microphone-button" aria-label="Start/Stop recording">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1 1.9c-2.7-.4-4.8-2.6-5-5.4h-2c.2 3.8 3.1 6.9 7 7.5V20h2v-2.6c3.9-.6 6.8-3.7 7-7.5h-2c-.2 2.8-2.3 5-5 5.4V15z"/>
                        </svg>
                    </button>
                </div>
            
                <!-- Bottom row with text buttons -->
                <div class="text-buttons-row">
                    <button class="text-button"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5"></path></svg>Import knowledge</button>
                    <button class="text-button"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 122.88 89.09"><g><path stroke-width="3.5" stroke="currentColor" fill="none" d="M3.97,9.75l-3.93,8.73l122.77,0.01l-3.96-8.74H55.82c-1.59,0-2.88-1.29-2.88-2.88V0H11.97v6.87 c0,1.59-1.29,2.88-2.88,2.88H3.97L3.97,9.75L3.97,9.75z"></path><path stroke-width="3.5" stroke="currentColor" fill="none" d="M4.63,18.48H0l7.03,67.03c0.11,1.07,0.55,2.02,1.2,2.69c0.55,0.55,1.28,0.89,2.11,0.89h100.1 c0.82,0,1.51-0.33,2.05-0.87c0.68-0.68,1.13-1.67,1.28-2.79l9.1-66.94H4.63V18.48L4.63,18.48z"></path></g></svg>work_dir Browser</button>
                    <button class="text-button" @click="pauseAgent(!paused)">
                            <!-- Dynamic path that switches between pause and play icons -->
                            <template x-if="!paused">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="14" height="14">
                                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
                            </template>
                            <template x-if="paused">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="14" height="14">
                                <path d="M8 5v14l11-7z"></path></svg>
                            </template>
                        </svg>
                        <span x-text="paused ? 'Resume Agent' : 'Pause Agent'"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="settingsModal" x-data="settingsModalProxy">
        <h1 x-text="settings.title"></h1>
        <template x-teleport="body">
            <div x-show="isOpen" class="modal-overlay" @click.self="handleCancel()"
                x-transition>
                <div class="modal-container">
                    <div class="modal-header">
                        <h2 x-text="settings.title"></h2>
                        <!-- Dynamically generated navigation -->
                        <nav>
                            <ul>
                                <!-- Loop over sections to generate links dynamically -->
                                <template x-for="(section, index) in settings.sections" :key="index">
                                    <li>
                                        <a :href="'#section' + (index + 1)" x-text="section.title"></a>
                                    </li>
                                </template>
                            </ul>
                        </nav>
                    </div>

                    <div class="modal-content">
                        <template x-for="(section, sectionIndex) in settings.sections" :key="sectionIndex">
                            <div :id="'section' + (sectionIndex + 1)" class="section">
                                <div class="section-title" x-text="section.title"></div>
                                <div class="section-description" x-text="section.description"></div>

                                <template x-for="(field, fieldIndex) in section.fields" :key="fieldIndex">
                                    <div :class="{'field': true, 'field-full': field.type === 'textarea'}">
                                        <div class="field-label">
                                            <div class="field-title" x-text="field.title"></div>
                                            <div class="field-description" x-text="field.description"></div>
                                        </div>

                                        <div class="field-control">
                                            <!-- Input field -->
                                            <template x-if="field.type === 'input'">
                                                <input type="text" :class="field.classes" :value="field.value"
                                                    :readonly="field.readonly === true"
                                                    @input="field.value = $event.target.value">
                                            </template>

                                            <!-- Textarea field -->
                                            <template x-if="field.type === 'textarea'">
                                                <textarea :class="field.classes" :value="field.value"
                                                    :readonly="field.readonly === true"
                                                    @input="field.value = $event.target.value"></textarea>
                                            </template>

                                            <!-- Switch field -->
                                            <template x-if="field.type === 'switch'">
                                                <label class="toggle">
                                                    <input type="checkbox" :checked="field.value"
                                                        :disabled="field.readonly === true"
                                                        @change="field.value = $event.target.checked">
                                                    <span class="toggler"></span>
                                                </label>
                                            </template>

                                            <!-- Range field -->
                                            <template x-if="field.type === 'range'">
                                                <div class="field-control">
                                                    <input type="range" :min="field.min" :max="field.max"
                                                        :step="field.step" :value="field.value"
                                                        :disabled="field.readonly === true"
                                                        @input="field.value = $event.target.value"
                                                        :class="field.classes">
                                                    <span class="range-value" x-text="field.value"></span>
                                                </div>
                                            </template>

                                            <!-- Button field -->
                                            <template x-if="field.type === 'button'">
                                                <button class="btn btn-field" :class="field.classes"
                                                    :disabled="field.readonly === true"
                                                    @click="handleFieldButton(field)" x-text="field.value"></button>
                                            </template>

                                            <!-- Select field -->
                                            <template x-if="field.type === 'select'">
                                                <select :class="field.classes" x-model="field.value"
                                                    :disabled="field.readonly === true">
                                                    <template x-for="option in field.options" :key="option.value">
                                                        <option :value="option.value" x-text="option.label"
                                                            :selected="option.value === field.value"></option>
                                                    </template>
                                                </select>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>

                    <div class="modal-footer">
                        <div id="buttons-container">
                        <template x-for="button in settings.buttons" :key="button.id">
                            <button :class="button.classes" @click="handleButton(button.id)"
                                x-text="button.title"></button>
                        </template>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

</body>

</html>
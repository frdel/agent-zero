<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Agent Zero</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="css/toast.css">
    <link rel="stylesheet" href="css/settings.css">
    <link rel="stylesheet" href="css/file_browser.css">
    <link rel="stylesheet" href="css/speech.css">
    <link rel="stylesheet" href="css/history.css">

    <script>
        window.safeCall = function (name, ...args) {
            if (window[name]) window[name](...args)
        }
    </script>

    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js" type="text/javascript" charset="utf-8"></script>

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" crossorigin="anonymous">

    <!-- KaTeX javascript -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>

    
    <script type="module" src="index.js"></script>
    <script type="text/javascript" src="js/settings.js"></script>
    <script type="text/javascript" src="js/file_browser.js"></script>
    <script type="text/javascript" src="js/modal.js"></script>
    <script type="module" src="js/speech.js"></script>
    <script type="module" src="js/history.js"></script>

</head>

<body>
    <div class="container">
        <div id="sidebar-overlay" class="sidebar-overlay hidden"></div>
        <div class="icons-section" id="hide-button" x-data="{ connected: true }">
            <!--Sidebar-->
            <!-- Sidebar Toggle Button -->
            <button id="toggle-sidebar" class="toggle-sidebar-button" aria-label="Toggle Sidebar" aria-expanded="false">
                <span aria-hidden="true">
                    <!-- Hamburger Icon -->
                    <svg id="sidebar-hamburger-svg" xmlns="http://www.w3.org/2000/svg" width="22" height="22"
                        viewBox="0 0 24 24" fill="CurrentColor">
                        <path d="M3 13h18v-2H3v2zm0 4h18v-2H3v2zm0-8h18V7H3v2z"></path>
                    </svg>
                </span>
            </button>

            <div id="logo-container">
                <a href="https://github.com/frdel/agent-zero" target="_blank" rel="noopener noreferrer">
                    <img src="./public/splash.jpg" alt="a0" width="22" height="22">
                </a>
            </div>
        </div>

        <div id="left-panel" class="panel">
            <!--Sidebar upper elements-->
            <div class="left-panel-top">
                <div class="config-section" x-data="{ showQuickActions: true }">
                    <h3>Quick Actions</h3>
                    <button class="config-button" id="resetChat" @click="resetChat()">Reset Chat</button>
                    <button class="config-button" id="newChat" @click="newChat()">New Chat</button>
                    <button class="config-button" id="loadChats" @click="loadChats()">Load Chat</button>
                    <button class="config-button" id="loadChat" @click="saveChat()">Save Chat</button>
                    <button class="config-button" id="settings"
                        @click="settingsModalProxy.openModal()">Settings</button>
                </div>
                <!-- Chats List -->
                <div class="config-section" id="chats-section" x-data="{ contexts: [], selected: '' }"
                    x-show="contexts.length > 0">
                    <h3>Chats</h3>
                    <div class="chats-list-container">
                        <ul class="config-list">
                            <template x-for="context in contexts">
                                <li>
                                    <span :class="{'chat-list-button': true, 'font-bold': context.id === selected}"
                                        @click="selected = context.id; selectChat(context.id)">
                                        Chat #<span x-text="context.no"></span>
                                    </span>
                                    <button class="edit-button" @click="killChat(context.id)">X</button>
                                </li>
                            </template>
                        </ul>
                    </div>
                </div>
            </div>
            <!--Sidebar lower elements-->
            <div class="left-panel-bottom">
                <!-- Preferences -->
                <div class="pref-section" x-data="{ prefOpen: true }">
                    <span>
                        <h3 class="pref-header" @click="prefOpen = !prefOpen">
                            Preferences
                            <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="2" width="16" height="16"
                                :class="{'rotated': !prefOpen}">
                                <path d="M8 4l8 8-8 8" />
                            </svg>
                        </h3>
                        <ul class="config-list" x-show="prefOpen" x-collapse x-transition>
                            <!-- Preferences Items -->
                            <li x-data="{ autoScroll: true }">
                                <span>Autoscroll</span>
                                <label class="switch">
                                    <input id="auto-scroll-switch" type="checkbox" x-model="autoScroll"
                                        x-effect="window.safeCall('toggleAutoScroll',autoScroll)">
                                    <span class="slider"></span>
                                </label>
                            </li>
                            <li x-data="{ darkMode: localStorage.getItem('darkMode') != 'false' }"
                                x-init="$watch('darkMode', val => toggleDarkMode(val))">
                                <span class="switch-label">Dark mode</span>
                                <label class="switch">
                                    <input type="checkbox" x-model="darkMode">
                                    <span class="slider"></span>
                                </label>
                            </li>
                            <li x-data="{ speech: localStorage.getItem('speech') == 'true' }"
                                x-init="$watch('speech', val => toggleSpeech(val))">
                                <span class="switch-label">Speech</span>
                                <label class="switch">
                                    <input type="checkbox" x-model="speech">
                                    <span class="slider"></span>
                                </label>
                            </li>
                            <li x-data="{ showThoughts: true }">
                                <span>Show thoughts</span>
                                <label class="switch">
                                    <input type="checkbox" x-model="showThoughts"
                                        x-effect="window.safeCall('toggleThoughts',showThoughts)">
                                    <span class="slider"></span>
                                </label>
                            </li>
                            <li x-data="{ showJson: false }">
                                <span>Show JSON</span>
                                <label class="switch">
                                    <input type="checkbox" x-model="showJson"
                                        x-effect="window.safeCall('toggleJson',showJson)">
                                    <span class="slider"></span>
                                </label>
                            </li>
                            <li x-data="{ showUtils: false }">
                                <span>Show utility messages</span>
                                <label class="switch">
                                    <input type="checkbox" x-model="showUtils"
                                        x-effect="window.safeCall('toggleUtils',showUtils)">
                                    <span class="slider"></span>
                                </label>
                            </li>
                        </ul>
                    </span>
                </div>
                <!-- Version Info -->
                <div class="version-info">
                    <span id="a0version">Version {{version_no}} {{version_time}}</span>
                </div>
            </div>
        </div>
        <div id="right-panel" class="panel">
            <!--Chat-->
            <div id="time-date-container">
                <div id="time-date"></div>
                <div class="status-icon" x-data="{ connected: true }">
                    <svg viewBox="0 0 30 30">
                        <!-- Cloud -->
                        <path class="cloud" 
                              x-bind:fill="connected ? '#00c340' : '#e40138'"
                              d="m23.12,19.85c3.8,0,6.88-3.09,6.88-6.88,0-3.39-2.53-6.31-5.88-6.81l-.68-.1-.27-.63c-1.4-3.29-4.61-5.42-8.17-5.42s-6.77,2.13-8.17,5.42l-.27.63-.68.1c-3.35.49-5.87,3.42-5.87,6.81,0,3.8,3.09,6.88,6.88,6.88.44,0,.8-.36.8-.8s-.36-.8-.8-.8c-2.91,0-5.28-2.37-5.28-5.28s2.37-5.28,5.28-5.28h.29c.37,0,.69-.25.78-.6.84-3.23,3.74-5.48,7.05-5.48s6.21,2.25,7.05,5.48c.09.35.41.6.78.6h.29c2.91,0,5.28,2.37,5.28,5.28s-2.37,5.28-5.28,5.28c-.44,0-.8.36-.8.8s.36.8.8.8Z"/>
              
                        <!-- Connected Symbol -->
                        <g class="symbol" transform="translate(9, 15)">
                            <path class="connected-symbol" 
                                  x-bind:fill="connected ? '#00c340' : '#e40138'"
                                  x-bind:opacity="connected ? 1 : 0"
                                  d="m.73,9.63c.23.02.48-.06.65-.21l3.63-3.28c.36-.32.58-.7.63-1.09.08-.56-.13-1.11-.57-1.5L1.61.42l-.24-.21C1.22.08,1.02,0,.8,0h-.1C.46.02.26.14.11.33-.08.6-.02.97.26,1.22l3.66,3.3c.08.08.13.18.13.29s-.05.22-.13.29L.31,8.36c-.3.27-.38.69-.18.95.15.19.35.3.6.32Z"/>
                            <path class="connected-line" 
                                  x-bind:fill="connected ? '#00c340' : '#e40138'"
                                  x-bind:opacity="connected ? 1 : 0"
                                  d="m11.16,7.94h-4.56c-.44,0-.8.36-.8.8s.36.8.8.8h4.56c.44,0,.8-.36.8-.8s-.36-.8-.8-.8Z"/>
              
                            <!-- Disconnected Symbol -->
                            <path class="disconnected-symbol"
                                  transform="translate(1, 0)"
                                  x-bind:fill="connected ? '#00c340' : '#e40138'"
                                  x-bind:opacity="connected ? 0 : 1"
                                  d="m5.64,4.88l3.34-3.59c.29-.31.27-.79-.04-1.08-.31-.29-.79-.27-1.08.04l-3.27,3.51L1.33.24C1.04-.07.55-.08.24.21-.07.49-.08.98.21,1.29l3.34,3.59L.21,8.46c-.29.31-.27.79.04,1.08.15.14.34.21.52.21.21,0,.41-.08.56-.24l3.27-3.51,3.27,3.51c.15.16.36.24.56.24.19,0,.37-.07.52-.21.31-.29.33-.77.04-1.08l-3.34-3.59Z"/>
                        </g>
                    </svg>
                </div>
              </div>
            <div id="chat-history">
            </div>
            <div id="toast" class="toast">
                <div class="toast__message"></div>
                <button class="toast__copy">Copy</button>
                <button class="toast__close">Close</button>
            </div>
            <div id="progress-bar-box" x-data="{ isSpeaking: false }" x-init="
            // Watch the speech synthesis status to update isSpeaking
            setInterval(() => isSpeaking = window.speech.isSpeaking(), 100)
        ">
                <h4 id="progress-bar-h">
                    <span id="progress-bar-i">|></span><span id="progress-bar"></span>
                </h4>
                <h4 id="progress-bar-stop-speech" x-show="isSpeaking">
                    <span id="stop-speech" @click="window.speech.stop()" style="cursor: pointer">Stop Speech</span>
                </h4>
            </div>
            <div id="input-section" x-data="{ 
                paused: false,
                attachments: [],
                hasAttachments: false,
                
                handleFileUpload(event) {
                    const files = event.target.files;
                    if (files.length + this.attachments.length > 4) {
                        alert('Maximum 4 attachments allowed');
                        return;
                    }
    
                    Array.from(files).forEach(file => {
                        const ext = file.name.split('.').pop().toLowerCase();
                        const allowedExts = new Set(['jpg', 'jpeg', 'png', 'bmp', 'md', 'py', 'js', 'sh', 
                                                    'html', 'css', 'pdf', 'txt', 'csv', 'json']);
                        
                        if (allowedExts.has(ext)) {
                            const isImage = ['jpg', 'jpeg', 'png', 'bmp'].includes(ext);
                            
                            if (isImage) {
                                // Handle image preview
                                const reader = new FileReader();
                                reader.onload = e => {
                                    this.attachments.push({
                                        file: file,
                                        url: e.target.result,
                                        type: 'image',
                                        name: file.name,
                                        extension: ext
                                    });
                                    this.hasAttachments = true;
                                };
                                reader.readAsDataURL(file);
                            } else {
                                // Handle other file types
                                this.attachments.push({
                                    file: file,
                                    type: 'file',
                                    name: file.name,
                                    extension: ext
                                });
                                this.hasAttachments = true;
                            }
                        }
                    });
                }
            }">

                <!-- Preview section -->
                <div x-show="hasAttachments" class="preview-section">
                    <template x-for="(attachment, index) in attachments" :key="index">
                        <div class="preview-item" :class="{'image-preview': attachment.type === 'image'}">
                            <template x-if="attachment.type === 'image'">
                                <img :src="attachment.url" :alt="attachment.name">
                            </template>
                            <template x-if="attachment.type === 'file'">
                                <div class="file-preview">
                                    <span class="filename" x-text="attachment.name"></span>
                                    <span class="extension" x-text="attachment.extension.toUpperCase()"></span>
                                </div>
                            </template>
                            <button @click="attachments.splice(index, 1); hasAttachments = attachments.length > 0"
                                class="remove-attachment">&times;</button>
                        </div>
                    </template>
                </div>

                <!-- Top row with input and buttons -->
                <div class="input-row">
                    <!-- Attachment icon with tooltip -->
                    <div class="attachment-wrapper" x-data="{ showTooltip: false }">
                        <label for="file-input" class="attachment-icon" @mouseover="showTooltip = true"
                            @mouseleave="showTooltip = false">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="currentColor">
                                <path
                                    d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z" />
                            </svg>
                        </label>
                        <input type="file" id="file-input"
                            accept=".png, .jpg, .jpeg, .txt, .pdf, .csv, .html, .json, .md, .py, .js, .sh, .css"
                            multiple style="display: none" @change="handleFileUpload($event)">

                        <div x-show="showTooltip" class="tooltip">
                            Limit: 4 attachments per message
                        </div>
                    </div>

                    <!-- Text input -->
                    <textarea id="chat-input" placeholder="Type your message here..." rows="1"></textarea>

                    <div id="chat-buttons-wrapper">
                        <!-- Send button -->
                        <button class="chat-button" id="send-button" aria-label="Send message">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                                <path d="M25 20 L75 50 L25 80" fill="none" stroke="currentColor" stroke-width="15">
                                </path>
                            </svg>
                        </button>

                        <!-- Microphone button -->
                        <button class="chat-button mic-inactive" id="microphone-button"
                            aria-label="Start/Stop recording">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 18" fill="currentColor" width="24"
                                height="24">
                                <path
                                    d="m8,12c1.66,0,3-1.34,3-3V3c0-1.66-1.34-3-3-3s-3,1.34-3,3v6c0,1.66,1.34,3,3,3Zm-1,1.9c-2.7-.4-4.8-2.6-5-5.4H0c.2,3.8,3.1,6.9,7,7.5v2h2v-2c3.9-.6,6.8-3.7,7-7.5h-2c-.2,2.8-2.3,5-5,5.4h-2Z" />
                            </svg>

                        </button>

                    </div>
                </div>

                <!-- Bottom row with text buttons -->
                <div class="text-buttons-row">

                    <button class="text-button" @click="pauseAgent(!paused)">
                        <!-- Dynamic path that switches between pause and play icons -->
                        <template x-if="!paused">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"
                                stroke-width="1.5" stroke="currentColor" width="14" height="14">
                                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path>
                            </svg>
                        </template>
                        <template x-if="paused">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"
                                stroke-width="1.5" stroke="currentColor" width="14" height="14">
                                <path d="M8 5v14l11-7z"></path>
                            </svg>
                        </template>
                        </svg>
                        <span x-text="paused ? 'Resume Agent' : 'Pause Agent'"></span>
                    </button>

                    <button class="text-button" @click="loadKnowledge()"><svg xmlns="http://www.w3.org/2000/svg"
                            fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5">
                            </path>
                        </svg>Import knowledge</button>
                        <button class="text-button" id="work_dir_browser" @click="fileBrowserModalProxy.openModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 123.37 92.59">
                            <path
                                d="m5.72,11.5l-3.93,8.73h119.77s-3.96-8.73-3.96-8.73h-60.03c-1.59,0-2.88-1.29-2.88-2.88V1.75H13.72v6.87c0,1.59-1.29,2.88-2.88,2.88h-5.12Z"
                                fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="5"></path>
                            <path
                                d="m6.38,20.23H1.75l7.03,67.03c.11,1.07.55,2.02,1.2,2.69.55.55,1.28.89,2.11.89h97.1c.82,0,1.51-.33,2.05-.87.68-.68,1.13-1.67,1.28-2.79l9.1-66.94H6.38Z"
                                fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="5"></path>
                        </svg>work_dir Browser</button>                    

                    <button class="text-button" id="history_inspect" @click="window.openHistoryModal()">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 123.37 92.59">
                            <path
                                d="m5.72,11.5l-3.93,8.73h119.77s-3.96-8.73-3.96-8.73h-60.03c-1.59,0-2.88-1.29-2.88-2.88V1.75H13.72v6.87c0,1.59-1.29,2.88-2.88,2.88h-5.12Z"
                                fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="5"></path>
                            <path
                                d="m6.38,20.23H1.75l7.03,67.03c.11,1.07.55,2.02,1.2,2.69.55.55,1.28.89,2.11.89h97.1c.82,0,1.51-.33,2.05-.87.68-.68,1.13-1.67,1.28-2.79l9.1-66.94H6.38Z"
                                fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="5"></path>
                        </svg>History</button>

                        <button class="text-button" id="ctx_window" @click="window.openCtxWindowModal()">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 123.37 92.59">
                                <path
                                    d="m5.72,11.5l-3.93,8.73h119.77s-3.96-8.73-3.96-8.73h-60.03c-1.59,0-2.88-1.29-2.88-2.88V1.75H13.72v6.87c0,1.59-1.29,2.88-2.88,2.88h-5.12Z"
                                    fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="5"></path>
                                <path
                                    d="m6.38,20.23H1.75l7.03,67.03c.11,1.07.55,2.02,1.2,2.69.55.55,1.28.89,2.11.89h97.1c.82,0,1.51-.33,2.05-.87.68-.68,1.13-1.67,1.28-2.79l9.1-66.94H6.38Z"
                                    fill="none" stroke="currentColor" stroke-linejoin="round" stroke-width="5"></path>
                            </svg>Context</button>

                </div>
            </div>
        </div>
    </div>
    <div id="settingsModal" x-data="settingsModalProxy">
        <template x-teleport="body">
            <div x-show="isOpen" class="modal-overlay" @click.self="handleCancel()" @keydown.escape.window="handleClose()" x-transition>
                <div class="modal-container">
                    <div class="modal-header" id="settings-title">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 960 960">
                            <path d="m717.77,788.27c-78.78-135.38-157.9-271.35-238.62-410.05-79.86,138.37-158.57,274.73-237.16,410.9h-121.99C239.91,581.87,479.49,170.89,479.49,170.89h0s240.63,410.03,360.51,617.38h-122.23Z" fill="currentColor" stroke-width="0"></path>
                            <path d="m633.08,788.85h-309.54c20.61-35.84,40.55-70.52,60.34-104.92h190.22c19.28,34.3,38.47,68.43,58.98,104.92Z" fill="currentColor" stroke-width="0"></path>
                          </svg>
                          <h2 x-text="settings.title"></h2>
                        <button class="modal-close" @click="handleCancel()">&times;</button>
                    </div>
                    
                    <div class="modal-content">
                        <div id="settings-sections">
                            <nav>
                              <ul>
                                <template x-for="(section, index) in settings.sections" :key="section.title">
                                    <li>
                                      <a :href="'#section' + (index + 1)">
                                        <img :src="'/public/' + getIconName(section.title) + '.svg'" :alt="section.title">
                                        <span x-text="section.title"></span>
                                      </a>
                                    </li>
                                </template>
                              </ul>
                            </nav>
                        </div>
                        <template x-for="(section, sectionIndex) in settings.sections" :key="sectionIndex">
                            <div :id="'section' + (sectionIndex + 1)" class="section">
                                <div class="section-title" x-text="section.title"></div>
                                <div class="section-description" x-text="section.description"></div>

                                <template x-for="(field, fieldIndex) in section.fields" :key="fieldIndex">
                                    <div :class="{'field': true, 'field-full': field.type === 'textarea'}">
                                        <div class="field-label">
                                            <div class="field-title" x-text="field.title"></div>
                                            <div class="field-description" x-text="field.description"></div>
                                        </div>

                                        <div class="field-control">
                                            <!-- Input field -->
                                            <template x-if="field.type === 'input'">
                                                <input type="text" :class="field.classes" :value="field.value"
                                                    :readonly="field.readonly === true"
                                                    @input="field.value = $event.target.value">
                                            </template>

                                            <!-- Password field -->
                                            <template x-if="field.type === 'password'">
                                                <input type="password" :class="field.classes" :value="field.value"
                                                    :readonly="field.readonly === true"
                                                    @input="field.value = $event.target.value">
                                            </template>

                                            <!-- Textarea field -->
                                            <template x-if="field.type === 'textarea'">
                                                <textarea :class="field.classes" :value="field.value"
                                                    :readonly="field.readonly === true"
                                                    @input="field.value = $event.target.value"></textarea>
                                            </template>

                                            <!-- Switch field -->
                                            <template x-if="field.type === 'switch'">
                                                <label class="toggle">
                                                    <input type="checkbox" :checked="field.value"
                                                        :disabled="field.readonly === true"
                                                        @change="field.value = $event.target.checked">
                                                    <span class="toggler"></span>
                                                </label>
                                            </template>

                                            <!-- Range field -->
                                            <template x-if="field.type === 'range'">
                                                <div class="field-control">
                                                    <input type="range" :min="field.min" :max="field.max"
                                                        :step="field.step" :value="field.value"
                                                        :disabled="field.readonly === true"
                                                        @input="field.value = $event.target.value"
                                                        :class="field.classes">
                                                    <span class="range-value" x-text="field.value"></span>
                                                </div>
                                            </template>

                                            <!-- Button field -->
                                            <template x-if="field.type === 'button'">
                                                <button class="btn btn-field" :class="field.classes"
                                                    :disabled="field.readonly === true"
                                                    @click="handleFieldButton(field)" x-text="field.value"></button>
                                            </template>

                                            <!-- Select field -->
                                            <template x-if="field.type === 'select'">
                                                <select :class="field.classes" x-model="field.value"
                                                    :disabled="field.readonly === true">
                                                    <template x-for="option in field.options" :key="option.value">
                                                        <option :value="option.value" x-text="option.label"
                                                            :selected="option.value === field.value"></option>
                                                    </template>
                                                </select>
                                            </template>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </div>

                    <div class="modal-footer">
                        <div id="buttons-container">
                            <template x-for="button in settings.buttons" :key="button.id">
                                <button :class="button.classes" @click="handleButton(button.id)"
                                    x-text="button.title"></button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>
    
    <!-- work_dir Browser Modal -->

    <div id="fileBrowserModal" x-data="fileBrowserModalProxy">
        <template x-teleport="body">
            <div x-show="isOpen" class="modal-overlay" @click.self="handleClose()" @keydown.escape.window="handleClose()" x-transition>
                <div class="modal-container">
                    <div class="modal-header" id="settings-title">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 960 960">
                            <path d="m717.77,788.27c-78.78-135.38-157.9-271.35-238.62-410.05-79.86,138.37-158.57,274.73-237.16,410.9h-121.99C239.91,581.87,479.49,170.89,479.49,170.89h0s240.63,410.03,360.51,617.38h-122.23Z" fill="#7a7a7a" stroke-width="0"/>
                            <path d="m633.08,788.85h-309.54c20.61-35.84,40.55-70.52,60.34-104.92h190.22c19.28,34.3,38.47,68.43,58.98,104.92Z" fill="#7a7a7a" stroke-width="0"/>
                          </svg>
                        <h2 class="modal-title" x-text="browser.title"></h2>
                        <button class="modal-close" @click="handleClose()">&times;</button>
                    </div>
                    <div class="modal-content">
                        <div x-show="isLoading" class="loading-spinner">
                            Loading...
                        </div>
                        <div x-show="!isLoading">
                            <div class="path-navigator">
                                <!-- Up Button -->
                                <button class="text-button back-button" 
                                @click="navigateUp()" 
                                aria-label="Navigate Up">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10.5 15">
                                        <path d="m.75,5.25L5.25.75m0,0l4.5,4.5M5.25.75v13.5" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"></path>
                                    </svg>
                                Up
                                </button>
                            
                                <span class="current-path" x-text="browser.currentPath || 'Current Path: /'"></span>
                            </div>
                            
                            <div class="files-list">
                                <!-- Header -->
                                <div class="file-header">
                                    <div class="file-cell" @click="toggleSort('name')">
                                        Name
                                        <span x-show="browser.sortBy === 'name'" 
                                            x-text="browser.sortDirection === 'asc' ? '↑' : '↓'">
                                        </span>
                                    </div>
                                    <div class="file-cell-size" @click="toggleSort('size')">
                                        Size
                                        <span x-show="browser.sortBy === 'size'"
                                            x-text="browser.sortDirection === 'asc' ? '↑' : '↓'">
                                        </span>
                                    </div>
                                    <div class="file-cell-date" @click="toggleSort('date')">
                                        Modified
                                        <span x-show="browser.sortBy === 'date'"
                                            x-text="browser.sortDirection === 'asc' ? '↑' : '↓'">
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- File List -->
                                <template x-if="browser.entries.length">
                                    <template x-for="file in sortFiles(browser.entries)" :key="file.path">
                                        <div class="file-item" :data-is-dir="file.is_dir">
                                            <div class="file-name" @click="file.is_dir ? navigateToFolder(file.path) : downloadFile(file)">
                                                <img :src="'/public/' + (file.type === 'unknown' ? 'file' : (isArchive(file.name) ? 'archive' : file.type)) + '.svg'" class="file-icon" :alt="file.type">
                                                <span x-text="file.name"></span>
                                            </div>
                                            <div class="file-size" x-text="formatFileSize(file.size)"></div>
                                            <div class="file-date" x-text="formatDate(file.modified)"></div>

                                            <div class="file-actions">
                                                <button class="action-button download-button" @click.stop="downloadFile(file)" x-show="!file.is_dir">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.5 19.5">
                                                      <path d="m.75,14.25v2.25c0,1.24,1.01,2.25,2.25,2.25h13.5c1.24,0,2.25-1.01,2.25-2.25v-2.25m-4.5-4.5l-4.5,4.5m0,0l-4.5-4.5m4.5,4.5V.75" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"></path>
                                                    </svg>
                                                </button>
                                                <button class="delete-button" @click.stop="deleteFile(file)" x-show="!file.is_dir || (file.is_dir &amp;&amp; file.size === 0)">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.03 22.53" fill="currentColor">
                                                    <path d="m14.55,7.82H4.68L14.09,3.19c.83-.41,1.17-1.42.77-2.25-.41-.83-1.42-1.17-2.25-.77l-3.16,1.55-.15-.31c-.22-.44-.59-.76-1.05-.92-.46-.16-.96-.13-1.39.09l-2.08,1.02c-.9.44-1.28,1.54-.83,2.44l.15.31-3.16,1.55c-.83.41-1.17,1.42-.77,2.25.29.59.89.94,1.51.94.25,0,.5-.06.74-.17l.38-.19s.09.03.14.03h11.14v11.43c0,.76-.62,1.38-1.38,1.38h-.46v-11.28c0-.26-.21-.47-.47-.47s-.47.21-.47.47v11.28h-2.39v-11.28c0-.26-.21-.47-.47-.47s-.47.21-.47.47v11.28h-2.39v-11.28c0-.26-.21-.47-.47-.47s-.47.21-.47.47v11.28h-.46c-.76,0-1.38-.62-1.38-1.38v-9.9c0-.26-.21-.47-.47-.47s-.47.21-.47.47v9.9c0,1.28,1.04,2.32,2.32,2.32h8.55c1.28,0,2.32-1.04,2.32-2.32v-11.91c0-.26-.21-.47-.47-.47ZM5.19,2.46l2.08-1.02c.12-.06.25-.09.39-.09.09,0,.19.02.28.05.22.08.4.23.5.44l.15.31-.19.09-3.46,1.7-.15-.31c-.21-.43-.03-.96.4-1.17Zm-3.19,5.62c-.36.18-.8.03-.98-.33-.18-.36-.03-.8.33-.98l5.8-2.85,2.72-1.34,3.16-1.55c.1-.05.21-.07.32-.07.27,0,.53.15.66.41.09.17.1.37.04.56-.06.18-.19.33-.37.42L2,8.08Z" stroke-width="0"></path>
                                                    </svg>
                                            </button>
                                            </div>
                                        </div>
                                    </template>
                                </template>
                                
                                <!-- Empty State -->
                                <template x-if="!browser.entries.length">
                                    <div class="no-files">
                                        No files found
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div id="buttons-container">
                            <label class="btn btn-upload"><svg xmlns="http://www.w3.org/2000/svg"
                                fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5">
                                </path>
                            </svg>
                                Upload Files
                                <input type="file" multiple="" 
                                       accept="all" 
                                       @change="handleFileUpload" 
                                       style="display: none;">
                            </label>
                            <button class="btn btn-cancel" @click="handleClose()">Close Browser</button>
                        </div>
                    </div>
                </div>
        </template>
    </div>

<!-- generic modal -->

<div id="genericModal" x-data="genericModalProxy">
    <template x-teleport="body">
        <div x-show="isOpen" class="modal-overlay" @click.self="handleClose()" @keydown.escape.window="handleClose()" x-transition>
            <div class="modal-container">
                <div class="modal-header">
                    <h2 class="modal-title" x-text="title"></h2>
                    <button class="modal-close" @click="handleClose()">&times;</button>
                </div>
                <div class="modal-description" x-text="description"></div>
                <div class="modal-content">
                    <div class="html-pre" x-html="html"></div>
                </div>
                <!-- <div class="modal-footer">
                    <div id="buttons-container">
                        <button class="btn btn-cancel" @click="handleClose()">Close</button>
                    </div>
                </div> -->
            </div>
    </template>
</div>

</body>

</html>
<!-- Login Overlay Component -->
<div x-data="loginOverlayData()" x-show="isVisible" x-cloak class="login-overlay">
    <div class="login-container">
        <div class="login-logo">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 1440" class="agent-logo">
                <path d="m922.78,720.83c-68.52-117.75-137.34-236.02-207.55-356.67-69.47,120.35-137.92,238.96-206.28,357.4h-106.11c104.3-180.26,312.68-537.74,312.68-537.74h0s209.3,356.65,313.57,537h-106.32Z" fill="currentColor" stroke-width="0"/>
                <path d="m849.11,721.33h-269.24c17.93-31.17,35.27-61.34,52.48-91.26h165.45c16.77,29.83,33.46,59.52,51.3,91.26Z" fill="currentColor" stroke-width="0"/>
                <path d="m855.05,1206.57c10.69,16.35,20.76,31.74,32.02,48.96h-34.84c-10.02-13.63-20.9-28.43-31.61-42.99h-39.57v42.82h-27.99v-147.26c16.45,0,32.16-.12,47.86.04,12.86.13,25.92-.69,38.54,1.21,20.63,3.1,36.67,14.08,41.02,35.55,4.51,22.21.88,42.92-19.45,57.3-1.72,1.22-3.4,2.49-5.98,4.38Zm-73.95-22.11c18.62,0,36.54,1.02,54.27-.36,11.76-.92,16.96-9.82,17.29-21.79.34-12.53-4.94-22.22-16.97-23.4-17.96-1.76-36.23-.46-54.58-.46v46.01Z" fill="currentColor" stroke-width="0"/>
                <path d="m403.72,1108.89v21.02c-28.68,32.22-57.1,64.16-87.72,98.55h87.05v27.1h-124.68v-28.42c25.73-28.55,52.05-57.74,81.02-89.88h-80.67v-28.36h124.98Z" fill="currentColor" stroke-width="0"/>
                <path d="m900.13,840.53c35.32,35,68.53,67.91,103.71,102.78v-84.31h25.96v148.54c-35.16-34.47-68.49-67.15-104.09-102.04v88.97h-25.59v-153.95Z" fill="currentColor" stroke-width="0"/>
                <path d="m1006.95,1219.73c7.56-3.75,18.36-8.63,24.87-11.86,22.7,30.27,57.55,23.3,72.48,9.86,14.93-13.44,19.41-32.85,13.81-52.29-7.32-18.81-23.54-33.49-47.3-32.66-23.76.83-44.67,17.75-46.66,46.2h-27.56c-.32-27.45,19.87-59.9,51.56-69.43,39.86-11.99,79.37,7.25,94.25,45.88,13.79,35.8-3.14,75.91-39.55,93.66-33.24,16.21-76.78,3.82-95.9-29.36Z" fill="currentColor" stroke-width="0"/>
                <path d="m562.28,879c-6.06,4.6-13.45,9.69-18.69,13.67-30.67-25.38-65.52-16.91-77.96,14.94-7.47,20.91,3.44,48.31,26.4,56.76,19.97,7.34,42.08-.34,47.83-17.24-4.74-1.43-9.47-2.86-15.47-4.68-.51-7.03-1.02-14.06-1.62-22.4h53.03c3.97,30.68-20.48,64.7-51.72,72.4-34.54,8.51-70.85-10.52-83.43-43.72-12.4-32.74,2.64-71.9,33.89-88.27,30.63-16.05,69.43-8.42,87.73,18.56Z" fill="currentColor" stroke-width="0"/>
                <path d="m270.94,848.74c26.4,50.55,50.96,97.57,76.62,146.71h-29.28c-15.28-27.69-30.93-56.05-47.5-86.07-15.85,29.74-30.73,57.67-45.91,86.16h-29.87c25.13-48.57,49.73-96.13,75.94-146.8Z" fill="currentColor" stroke-width="0"/>
                <path d="m1170.37,881.96h-49.28v-25.32h123.91v25.33h-47.34v112.78h-27.29v-112.8Z" fill="currentColor" stroke-width="0"/>
                <g>
                    <path d="m553.53,1135.42v36.02l34.56.5s-.01,16.45-.01,27.57c-14.07.49-29.08.24-42.92-3.03-11.71-2.77-20.12-12.39-20.64-25.22-.82-20.25-.22-41.56-.22-63.12h118.59v27.28h-89.36Z" fill="currentColor" stroke-width="0"/>
                    <path d="m524.56,1255.14v-37.59c7.73-.35,14.91-.68,22.44-1.03,1.9,3.83,1.68,10.85,5.45,11.01,3.77.16,58.97,0,89.86,0v27.61h-117.75Z" fill="currentColor" stroke-width="0"/>
                </g>
                <g>
                    <path d="m712.11,883.49v33.32l31.97.46s-.01,15.22-.01,25.51c-13.07.22-26.9.22-39.7-2.8-10.83-2.56-18.61-11.46-19.09-23.33-.76-18.74-.2-38.45-.2-58.39h109.71v25.23h-82.67Z" fill="currentColor" stroke-width="0"/>
                    <path d="m685.31,994.24v-34.77c7.15-.33,13.79-.63,20.76-.95,1.75,3.54,1.55,10.04,5.04,10.18,3.49.15,54.55,0,83.12,0v25.54h-108.93Z" fill="currentColor" stroke-width="0"/>
                </g>
            </svg>
        </div>

        <div class="login-form">
            <h2 class="login-title">Welcome to Agent Zero</h2>
            <p class="login-subtitle">Please sign in to continue</p>

            <!-- Messages -->
            <div x-show="error" x-cloak class="login-message login-error">
                <span x-text="error"></span>
            </div>

            <div x-show="success" x-cloak class="login-message login-success">
                <span x-text="success"></span>
            </div>

            <form @submit.prevent="authenticate()">
                <div class="login-field">
                    <label for="loginUsername">Username</label>
                    <input type="text"
                           id="loginUsername"
                           x-model="authForm.username"
                           placeholder="Enter your username"
                           required
                           autocomplete="username">
                </div>

                <div class="login-field">
                    <label for="loginPassword">Password</label>
                    <input type="password"
                           id="loginPassword"
                           x-model="authForm.password"
                           placeholder="Enter your password"
                           required
                           autocomplete="current-password">
                </div>

                <button type="submit"
                        class="login-button"
                        :disabled="loading">
                    <span x-show="!loading">Sign In</span>
                    <span x-show="loading" x-cloak>Signing In...</span>
                </button>
            </form>
        </div>
    </div>
</div>

<script>
function loginOverlayData() {
    return {
        isVisible: true, // Start visible by default, will hide if authenticated
        loading: false,
        error: '',
        success: '',
        authForm: {
            username: '',
            password: ''
        },

        init() {
            // Add class initially since overlay starts visible
            document.body.classList.add('login-overlay-visible');

            // Pause API calls and polling initially since overlay starts visible
            if (window.pauseApiCalls) {
                window.pauseApiCalls();
            }
            if (window.pausePolling) {
                window.pausePolling();
            }

            // Listen for show login overlay events
            this.$el.addEventListener('showLoginOverlay', () => {
                this.showOverlay();
            });

            // Check if user is authenticated on init
            this.checkAuthStatus();

            // Also listen for global authentication failures
            window.addEventListener('authenticationRequired', () => {
                this.showOverlay();
            });

            // Listen for logout events specifically
            window.addEventListener('userLogout', () => {
                this.showOverlay();
            });

            // Check authentication when page becomes visible (user switches back to tab)
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    this.checkAuthStatus();
                }
            });
        },

        async checkAuthStatus() {
            try {
                // Clear any potentially cached authentication state before checking
                try {
                    // Remove any stale authentication indicators
                    localStorage.removeItem('isAuthenticated');
                } catch (e) {
                    // Ignore localStorage errors
                }

                // Use raw fetch for auth check (bypass API pause system)
                const response = await fetch('/auth_check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({}),
                    credentials: 'same-origin', // Ensure cookies are sent
                    cache: 'no-cache' // Prevent cached responses
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.authenticated === true) {
                        // User is authenticated, resume API calls and hide overlay
                        if (window.resumeApiCalls) {
                            window.resumeApiCalls();
                        }
                        this.hideOverlay();
                    } else {
                        // Not authenticated, show overlay
                        this.showOverlay();
                    }
                } else {
                    // HTTP error status, likely authentication failure
                    this.showOverlay();
                }
            } catch (error) {
                // Network error or other failure, show overlay
                console.warn('Authentication check failed:', error);
                this.showOverlay();
            }
        },

        showOverlay() {
            this.isVisible = true;
            this.error = '';
            this.success = '';

            // Add class to hide notification bell
            document.body.classList.add('login-overlay-visible');

            // Pause API calls and polling when overlay is shown
            if (window.pauseApiCalls) {
                window.pauseApiCalls();
            }
            if (window.pausePolling) {
                window.pausePolling();
            }

            // Focus on username field after overlay appears
            this.$nextTick(() => {
                const usernameField = document.getElementById('loginUsername');
                if (usernameField) {
                    usernameField.focus();
                }
            });
        },

        hideOverlay() {
            this.isVisible = false;
            this.authForm.username = '';
            this.authForm.password = '';
            this.error = '';
            this.success = '';

            // Remove class to show notification bell again
            document.body.classList.remove('login-overlay-visible');

            // Reset auth failure flag to allow future authentication checks
            window.authFailureTriggered = false;

            // Resume API calls and polling when overlay is hidden
            if (window.resumeApiCalls) {
                window.resumeApiCalls();
            }
            if (window.resumePolling) {
                window.resumePolling();
            }
        },

        async authenticate() {
            if (!this.authForm.username || !this.authForm.password) {
                this.error = 'Please enter both username and password';
                return;
            }

            this.loading = true;
            this.error = '';

            try {
                // Clear any cached CSRF token before attempting login
                if (window.clearCsrfToken) {
                    window.clearCsrfToken();
                }

                const response = await fetch('/user_authenticate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-store'
                    },
                    body: JSON.stringify({
                        username: this.authForm.username,
                        password: this.authForm.password
                    }),
                    credentials: 'same-origin',
                    cache: 'no-cache'
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    this.success = 'Authentication successful';

                    // Clear any cached CSRF token to force refresh
                    if (window.clearCsrfToken) {
                        window.clearCsrfToken();
                    }

                    // Allow some time for session cookie to be stored, then verify
                    setTimeout(async () => {
                        try {
                            const chk = await fetch('/auth_check', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Cache-Control': 'no-store' }, body: JSON.stringify({}), credentials: 'same-origin', cache: 'no-cache' });
                            if (chk.ok) {
                                // Hide overlay and resume APIs only after confirmed auth
                                this.hideOverlay();
                                if (window.resumeApiCalls) { window.resumeApiCalls(); }
                                this.triggerComponentRefresh();
                            } else {
                                this.error = 'Session not ready, retrying...';
                                await this._retryLoginOnce();
                            }
                        } catch (e) {
                            this.error = 'Session check failed, retrying...';
                            await this._retryLoginOnce();
                        }
                    }, 250);
                } else {
                    this.error = data.message || 'Authentication failed, retrying...';
                    await this._retryLoginOnce();
                }
            } catch (error) {
                console.error('Authentication error:', error);
                this.error = 'Network error, retrying...';
                await this._retryLoginOnce();
            } finally {
                this.loading = false;
            }
        },

        async _retryLoginOnce() {
            try {
                // Clear CSRF again before retry
                if (window.clearCsrfToken) { window.clearCsrfToken(); }
                const response = await fetch('/user_authenticate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Cache-Control': 'no-store' },
                    body: JSON.stringify({ username: this.authForm.username, password: this.authForm.password }),
                    credentials: 'same-origin',
                    cache: 'no-cache'
                });
                const data = await response.json();
                if (response.ok && data.success) {
                    setTimeout(async () => {
                        try {
                            const chk = await fetch('/auth_check', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Cache-Control': 'no-store' }, body: JSON.stringify({}), credentials: 'same-origin', cache: 'no-cache' });
                            if (chk.ok) {
                                this.hideOverlay();
                                if (window.resumeApiCalls) { window.resumeApiCalls(); }
                                this.triggerComponentRefresh();
                            } else {
                                this.error = 'Login session not established. Please try again.';
                            }
                        } catch (e) {
                            this.error = 'Login session verification failed. Please try again.';
                        }
                    }, 250);
                }
            } catch (e) {
                // Give up; user will see error
            }
        },

        triggerComponentRefresh() {
            // Trigger refresh of components that depend on authentication
            // This allows Alpine.js components to react to the new auth state

            // Trigger a custom event that components can listen to
            window.dispatchEvent(new CustomEvent('authenticationSuccess'));

            // Restart polling if needed
            if (window.startPolling) {
                window.startPolling();
            }

            // Don't call checkAuthStatus again - we just authenticated successfully
            // The overlay is already hidden and session is established
        }
    }
}
</script>
